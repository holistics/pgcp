#!/usr/bin/env ruby
require 'yaml'
require 'thor'
require 'active_support'
require 'active_support/core_ext'
require './lib/transport'
require './lib/pgcp'

class PgcpRunner < Thor
  desc 'cp', 'Perform copies of tables between Postgres databases'
  method_option :source, type: :string, aliases: '-s', desc: 'Source database', required: true
  method_option :dest, type: :string, aliases: '-d', desc: 'Destination database', required: true
  method_option :table, type: :string, aliases: '-t', desc: 'Table to be copied', required: true
  method_option :config, type: :string, aliases: '-c', desc: 'Path to config file'
  method_option :log, type: :string, aliases: '-l', desc: 'Path to log file'
  def cp
    config = load_config_file(options['config'] || File.join(ENV['HOME'], '.pgcp.yml'))
    if options['log']
      Pgcp.log_file = options['log']
    end

    src = config['databases'][options['source']].symbolize_keys!
    dest = config['databases'][options['dest']].symbolize_keys!

    tr = Transport.new(src, dest)
    tr.copy_table(options['table'])
  end

  default_task :cp

  private
  def load_config_file(path)
    config = {}
    if not path.nil? and File.exists?(path)
      config = YAML::load_file(path)
    end

    config
  end
end

PgcpRunner.start
